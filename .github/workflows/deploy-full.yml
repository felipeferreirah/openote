name: Build & Deploy Openote (Low Resource)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
          platforms: linux/amd64

  deploy:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 25
    environment: production

    steps:
      - name: Deploy to DigitalOcean (Low Resource Mode)
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          command_timeout: 20m
          script_stop: true
          envs: GITHUB_TOKEN,GITHUB_ACTOR
          script: |
            set -e
            
            echo "ğŸš€ Starting LOW RESOURCE deployment..."
            echo "âš™ï¸  Optimized for 1GB RAM droplet"
            
            cd /home/openote
            
            # Login no GHCR
            echo "ğŸ“¦ Logging into GHCR..."
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
            
            # PASSO 1: Preparar ambiente (baixa pressÃ£o)
            echo ""
            echo "ğŸ“‹ Step 1/6: Preparing environment..."
            
            # Parar app primeiro (libera RAM)
            echo "  â†’ Stopping app container..."
            docker compose stop app 2>/dev/null || true
            sleep 3
            
            # Remover container antigo
            echo "  â†’ Removing old container..."
            docker compose rm -f app 2>/dev/null || true
            sleep 2
            
            # PASSO 2: Limpeza preventiva (libera espaÃ§o)
            echo ""
            echo "ğŸ§¹ Step 2/6: Cleaning up old images..."
            
            # Remove imagens antigas do openote (exceto a atual)
            docker images | grep 'felipeferreirah/openote' | grep -v 'latest' | awk '{print $3}' | xargs -r docker rmi -f 2>/dev/null || true
            
            # Remove imagens dangling
            docker image prune -f 2>/dev/null || true
            sleep 2
            
            # PASSO 3: Download da nova imagem (LENTO mas seguro)
            echo ""
            echo "â¬‡ï¸  Step 3/6: Downloading new image (this may take a while)..."
            echo "  â„¹ï¸  Using slow pull to avoid memory spikes"
            
            # Pull com limite de banda e retry (FORÃ‡ANDO SEM CACHE)
            for attempt in {1..3}; do
              echo "  â†’ Attempt $attempt/3..."
              
              # Pull com nice (baixa prioridade) e ionice (I/O baixo)
              if nice -n 19 ionice -c3 docker pull --no-cache ghcr.io/felipeferreirah/openote:latest 2>&1 | while IFS= read -r line; do
                # Mostra progresso a cada 10%
                if echo "$line" | grep -q "Extracting"; then
                  echo "$line" | grep -o '\[[^]]*\]' || true
                fi
              done; then
                echo "  âœ… Download complete!"
                break
              else
                if [ $attempt -eq 3 ]; then
                  echo "  âŒ Download failed after 3 attempts"
                  exit 1
                fi
                echo "  âš ï¸  Download failed, waiting 15s before retry..."
                sleep 15
              fi
            done
            
            sleep 3
            
            # PASSO 4: Verificar recursos antes de iniciar
            echo ""
            echo "ğŸ“Š Step 4/6: Checking system resources..."
            
            # Mostra uso de memÃ³ria
            echo "  Memory usage:"
            free -h | grep -E "Mem|Swap"
            
            # Mostra uso de disco
            echo "  Disk usage:"
            df -h / | grep -v "Filesystem"
            
            sleep 2
            
            # PASSO 5: Iniciar novo container (com limites de recursos)
            echo ""
            echo "ğŸš€ Step 5/6: Starting new container with resource limits..."
            
            # Inicia com docker compose (jÃ¡ tem os limites) - FORÃ‡ANDO RECREAÃ‡ÃƒO
            docker compose up -d app --force-recreate --pull always
            
            # Aguarda inicializaÃ§Ã£o gradual
            echo "  â†’ Waiting for container initialization..."
            for i in {1..30}; do
              if docker compose ps app 2>/dev/null | grep -q "Up"; then
                echo "  âœ… Container is running!"
                break
              fi
              echo -n "."
              sleep 2
            done
            echo ""
            
            sleep 5
            
            # PASSO 6: ValidaÃ§Ã£o e cleanup final
            echo ""
            echo "âœ”ï¸  Step 6/6: Final validation..."
            
            # Verifica se estÃ¡ rodando
            if docker compose ps app | grep -q "Up"; then
              echo "  âœ… Container is healthy!"
              
              # Mostra stats do container
              echo ""
              echo "ğŸ“Š Container resource usage:"
              docker stats --no-stream openote_app --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
              
            else
              echo "  âŒ Container failed to start properly"
              echo ""
              echo "ğŸ“‹ Last 30 lines of logs:"
              docker compose logs app --tail=30
              exit 1
            fi
            
            # Cleanup final suave
            echo ""
            echo "ğŸ§¹ Final cleanup..."
            docker image prune -f --filter "until=48h" 2>/dev/null || true
            
            # Logout
            docker logout ghcr.io 2>/dev/null || true
            
            # Status final
            echo ""
            echo "ğŸ‰ Deployment completed successfully!"
            echo ""
            echo "ğŸ“Š Final system status:"
            free -h | grep -E "Mem|Swap"
            df -h / | grep -v "Filesystem"

      - name: Post-Deploy Health Check
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 2m
          script: |
            cd /home/openote
            
            echo "ğŸ¥ Health Check Report"
            echo "====================="
            echo ""
            
            echo "ğŸ“¦ Container Status:"
            docker compose ps
            echo ""
            
            echo "ğŸ’¾ Resource Usage:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"
            echo ""
            
            echo "ğŸ“‹ Application Logs (last 15 lines):"
            docker compose logs app --tail=15
            echo ""
            
            echo "âœ… Health check completed!"

  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… LOW RESOURCE Deployment completed successfully!"
            echo "ğŸ¯ Optimized for 1GB RAM Digital Ocean Droplet"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi