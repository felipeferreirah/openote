name: Next.js CI/CD Pipeline

on:
  # push:
    # branches: [ main ]
  workflow_dispatch:

env:
  ARTIFACT_NAME: nextjs-build.tar.gz

jobs:
  prepare:
    name: ğŸ§° Prepare Environment
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ƒï¸ Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            node_modules
          key: nextjs-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

  build:
    name: ğŸ—ï¸ Build Next.js
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§± Build Next.js
        run: npm run build

      - name: ğŸ“¦ Package production build
        run: |
          mkdir deploy
          cp -R .next deploy/
          cp -R public deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cd deploy
          npm ci --omit=dev
          cd ..
          tar -czvf $ARTIFACT_NAME -C deploy .

      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: ${{ env.ARTIFACT_NAME }}

  deploy:
    name: ğŸš€ Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: build
    environment: production   # â¬…ï¸ ESSENCIAL para acessar os Environment Secrets!

    steps:
      - name: ğŸ“¥ Download artifact from build
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: .

      # ğŸ” Copiando build para o droplet
      - name: ğŸŒ Upload build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          source: nextjs-build.tar.gz
          target: /home/openote/

      # ğŸš€ Rodando deploy via SSH
      - name: ğŸ”„ Run remote redeploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          timeout: 180s
          script: |
            echo "ğŸ“¦ Extraindo build..."
            mkdir -p /home/openote/deploy
            rm -rf /home/openote/deploy/*
            tar -xzvf /home/openote/nextjs-build.tar.gz -C /home/openote/deploy/

            echo "ğŸ“ Copiando .env para o deploy..."
            cp /home/openote/.env /home/openote/deploy/.env

            echo "ğŸ“¦ Instalando dependÃªncias de produÃ§Ã£o..."
            cd /home/openote/deploy
            npm ci --omit=dev

            echo "ğŸ”„ Reiniciando PM2..."
            pm2 delete openote || true
            pm2 start "npm start -- -H 0.0.0.0" --name openote --cwd /home/openote/deploy

            echo "ğŸ’¾ Salvando PM2..."
            pm2 save

            echo "ğŸš€ Deploy finalizado com sucesso!"
