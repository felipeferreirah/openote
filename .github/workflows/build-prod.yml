name: Next.js CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ARTIFACT_NAME: nextjs-build.tar.gz

jobs:
  # ==========================================
  # 1ï¸âƒ£ PREPARAR AMBIENTE
  # ==========================================
  prepare:
    name: ğŸ§° Prepare Environment
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ƒï¸ Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            node_modules
          key: nextjs-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

  # ==========================================
  # 2ï¸âƒ£ BUILD NEXT.JS
  # ==========================================
  build:
    name: ğŸ—ï¸ Build Next.js
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§± Build Next.js
        run: npm run build

      - name: ğŸ“¦ Package production build
        run: |
          mkdir deploy
          cp -R .next deploy/
          cp -R public deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cd deploy
          npm ci --omit=dev
          cd ..
          tar -czvf $ARTIFACT_NAME -C deploy .

      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: ${{ env.ARTIFACT_NAME }}

  # ==========================================
  # 3ï¸âƒ£ DEPLOY PARA DIGITAL OCEAN
  # ==========================================
  deploy:
    name: ğŸš€ Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: ğŸ“¥ Download artifact from build
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: .

      # ğŸ“¦ UPLOAD DO BUILD PARA O SERVIDOR
      - name: ğŸŒ Upload build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          source: nextjs-build.tar.gz
          target: /root/openote/

      # ğŸš€ RODAR DEPLOY VIA SSH
      - name: ğŸ”„ Run remote redeploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          timeout: 180s
          script: |
            echo "ğŸ“¦ Extraindo build..."
            mkdir -p /root/openote/deploy
            rm -rf /root/openote/deploy/*
            tar -xzvf /root/openote/nextjs-build.tar.gz -C /root/openote/deploy/

            echo "ğŸ›  Instalando dependÃªncias de produÃ§Ã£o..."
            cd /root/openote/deploy
            npm ci --omit=dev

            echo "ğŸ”„ Reiniciando PM2..."
            pm2 delete openote || true
            pm2 start npm --name "openote" -- start

            echo "ğŸš€ Deploy finalizado com sucesso!"
