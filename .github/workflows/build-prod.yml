
name: Next.js CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  ARTIFACT_NAME: nextjs-build.tar.gz

# ==========================================
# 1ï¸âƒ£ PREPARE ENVIRONMENT
# ==========================================
jobs:
  prepare:
    name: ğŸ§° Prepare Environment
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ—ƒï¸ Cache Next.js build
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            node_modules
          key: nextjs-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            nextjs-${{ runner.os }}

      - name: ğŸ“¥ Install dependencies
        run: npm ci

# ==========================================
# 2ï¸âƒ£ BUILD NEXT.JS
# ==========================================
  build:
    name: ğŸ—ï¸ Build Next.js
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§± Build Next.js
        run: npm run build

      - name: ğŸ“¦ Package production build
        run: |
          mkdir deploy
          cp -R .next deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp -R public deploy/
          echo "ğŸ§¹ Instalando dependÃªncias de produÃ§Ã£o..."
          cd deploy
          npm ci --omit=dev
          cd ..
          tar -czvf $ARTIFACT_NAME -C deploy .

      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: ${{ env.ARTIFACT_NAME }}

# ==========================================
# 3ï¸âƒ£ DEPLOY TO DIGITAL OCEAN
# ==========================================
  deploy:
    name: ğŸš€ Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: ğŸ“¥ Download artifact from build
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: .

      - name: ğŸ§­ Sync server repo
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          script: |
            cd /root/openote
            git fetch origin master
            git reset --hard origin/master

      - name: ğŸŒ Upload build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          source: nextjs-build.tar.gz
          target: /root/openote/

      - name: ğŸ”„ Run remote redeploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          timeout: 180s
          script: |
            echo "ğŸ“¦ Extraindo build..."
            cd /root/openote
            rm -rf deploy/
            mkdir deploy
            tar -xzvf nextjs-build.tar.gz -C deploy/

            echo "ğŸ”„ Reiniciando serviÃ§o..."
            pm2 delete openote || true
            pm2 start deploy/node_modules/.bin/next --name openote -- start -p 3000

            echo "ğŸš€ Deploy finalizado!"
